\section{Introducción}
\label{sec:introduccion}

El presente trabajo describe en detalle el diseño y la implementación de un sistema de persistencia de datos presentado sobre un problema representativo -aunque simplificado- del mundo real.
  
La metodología de diseño utilizada fue la Metodología de Diseño Lógico para Bases de Datos Relacionales (LRDM - Logical Relational Design Methodology), la cual tiene como primer paso la desambiguación de los requerimientos planteados en el problema y la construcción consecuente del Modelo Entidad Relación para el escenario en cuestión. La forma de representación utilizada para dicho modelo conceptual fue el Diagrama Entidad Relación.

En una etapa posterior, pasamos al diseño lógico de la solución transformando el conocimiento comprendido en el DER al modelo relacional, al partir del cual se procede a la implementación de la solución en un motor de base de datos relacional. En este caso, el motor elegido para la implementación concreta fue SQLite\footnote{https://www.sqlite.org/}. 

\subsection{Descripción del Problema}

El problema para el cual se desarrolló un sistema de persistencia de datos consiste en un Mercado Virtual de intención similar a las comunidades de compra y venta online como MercadoLibre u OLX.

El sistema permite que sus usuarios publiquen artículos o servicios para ser comprados o contratados por otros usuarios. Los usuarios del sistema pueden ser particulares o empresas, teniendo iguales atribuciones y deberes a la hora de publicar, comprar o vender productos en el mercado. Los usuarios pueden ofrecer productos o servicios (o combinaciones de ambos) a un precio fijo o someter sus publicaciones a una subasta donde se establece un precio inicial y durante un tiempo determinado los demás usuarios pueden realizar ofertas con valores crecientes.

El mercado tiene una comisión por cada publicación realizada que deviene en una compra, pudiendo ser las publicaciones de  distintos tipos y con diferentes valores de comisión o extensión del período de vigencia de las mismas. Todas las publicaciones permiten adicionalmente que los usuarios que las visitan realicen preguntas al vendedor, quien puede responderlas. 

Las compras y ventas realizadas en el sitio siempre llevan una calificación obligatoria por parte de tanto el vendedor como el comprador, con una valoración numérica de 1 (no recomendable) a 10 (muy recomendable) así como un comentario opcional para el otro usuario involucrado en la transacción.

El sistema almacena adicionalmente el historial de compras de los usuarios, sus visitas a publicaciones, y aquellos productos o servicios que los usuarios hayan marcado como favoritos.

Los detalles más específicos del problema se encuentran en el enunciado del trabajo práctico\footnote{http://www.dc.uba.ar/materias/bd/2016/c1/descargas/TP1}.

\subsection{Funcionalidades a implementar}

Como requerimientos adicionales a la persistencia, hay una serie de funcionalidades particulares que implementamos de forma tal de verificar el correcto funcionamiento de la base. Estas son: 

\begin{itemize}
 \item Consulta por usuario: obtener, para un usuario específico, información sobre los artículos que ha
comprado y vendido, los artículos que ha visitado con su fecha de visita, los artículos que tiene
en su lista de favoritos, y las primeras 3 categorías de artículos que visitó con mayor frecuencia
en el último año.

 \item Consulta por categoría de producto: obtener, dada una categoría de producto (``Computación'',
``Hogar, muebles y jardín'', etc), un listado de los vendedores que han publicado artículos de dicha
categoría y la cantidad de ventas que efectuó cada uno de dichos vendedores.

 \item Función ``Ofertar'': debe permitir al usuario ofertar una suma en una subasta. Dicha suma debe
ser superior en al menos 1 peso, a la oferta actual, e inferior al doble de la oferta actual.

 \item Consulta por usuario y preguntas: obtener para un usuario específico, la lista de preguntas que
ha realizado, con las respectivas respuestas que haya recibido (sólo la pregunta, si aún no recibió
respuesta).

 \item Consulta por keyword: obtener, para un cierto keyword (por ejemplo ``mesa''), la lista de publicaciones
vigentes que tengan en el título, dicha keyword. El usuario debe poder restringir su
búsqueda sólo a cierta categoría de artículos o servicios.
 
 \item Consulta por ganador/es anual de viaje a Khan El-Khalili: obtener, para un año específico, el ganador/es
\end{itemize}

\section{Modelo de Entidad Relación}
\label{sec:modelo-de-entidad-relacion}

Como dijimos en la sección \ref{sec:introduccion}, para representar el Modelo de Entidad Relación realizado utilizamos el Diagrama Entidad Relación (DER). Presentado en las subsiguientes figuras, el DER fue dividido en diferentes secciones lógicas para facilitar su navegación, pero conceptualmente se trata de un único diagrama. Las divisiones constan de una sección central que incluye las interrelaciones más relevantes entre las entidades de Usuario, Publicación y Compra; y luego, una sección por cada una de estas tres entidades mostrando en detalle su composición y entidades relacionadas.

\begin{landscape}
    \begin{figure}[h]
        \frame{\includegraphics[scale=0.7]{der/central.pdf}}
        \captionof{figure}{Diagrama Entidad Relación: Sección Central.}
    \end{figure}
\end{landscape}

\begin{landscape}
    \begin{figure}[h]
        \frame{\includegraphics[scale=0.7]{der/usuario.pdf}}
        \captionof{figure}{Diagrama Entidad Relación: Sección Usuario.}
    \end{figure}
\end{landscape}

\begin{landscape}
    \begin{figure}[h]
        \frame{\includegraphics[scale=0.7]{der/publicacion.pdf}}
        \captionof{figure}{Diagrama Entidad Relación: Sección Publicación.}
    \end{figure}
\end{landscape}

\begin{landscape}
    \begin{figure}[h]
        \frame{\includegraphics[scale=0.7]{der/compra.pdf}}
        \captionof{figure}{Diagrama Entidad Relación: Sección Compra.}
    \end{figure}
\end{landscape}


\section{Decisiones de diseño}
\label{sec:decisiones-de-diseno}

\begin{itemize}
    \item Preguntas a una publicación: consideramos que las preguntas realizadas en una publicación pueden tener una única respuesta, siguiendo el modelo de MercadoLibre. Si el usuario desea replicar la respuesta, debe hacerlo mediante una nueva pregunta.
\end{itemize}


\section{Modelo Relacional}
\label{sec:modelo-relacional}

A continuación incluimos los esquemas de relación que se derivan del MER de la sección \ref{sec:modelo-de-entidad-relacion}.

\input{mr}

\section{Restricciones}
\label{sec:restricciones}

El problema presenta diferentes restricciones que no se encuentran modeladas en las representaciones previas (MER, MR), así como no se imponen de forma automática por el motor de la base de datos. Por lo tanto, es responsabilidad de quien ingresa los datos asegurar que se cumplan. Exampresamos en lenguaje natural dichas restricciones:

\begin{itemize}
  \item En la entidad Calificación, las valoraciones toman valores en el rango de 1 a 10.
  \item Tanto para Categoria Producto, Tipo Servicio y Categoria Empresa, las subcategorias de las mismas no deben tener ciclos.
  \item Dentro de Tipo de Publicacion estan tanto RubíDeOriente, Oro, Plata, Bronce y Libre!. Además, estas cumplen las restricciones del enunciado\footnote{http://www.dc.uba.ar/materias/bd/2016/c1/descargas/TP1} respecto a porcentajes y prioridad en las busquedas.
  \item Los pagos y los precios siempre son numeros positivos. Esto es, tanto monto en la entidad hizoOferta, precio en publicacion y monto en pago no son negativos
\end{itemize}

\section{Implementación SQL}
\label{sec:implementacion-sql}

\input{impl-sql}

\section{Conclusiones}
\label{sec:conclusiones}

\newpage
\appendix
\section{Creación de tablas} \label{App:AppendixA}

\verbatiminput{../base/creacion.sql}

\newpage
\section{Funcionalidades adicionales} \label{App:AppendixB}

$\bullet$ Consulta por usuario: obtener, para un usuario específico, información sobre los artículos que ha
comprado y vendido, los artículos que ha visitado con su fecha de visita, los artículos que tiene
en su lista de favoritos, y las primeras 3 categorías de artículos que visitó con mayor frecuencia
en el último año.

\begin{verbatim}
SELECT publicacion.*
FROM publicacion
INNER JOIN publicacionFinalizada
    ON publicacionFinalizada.idPublicacion = publicacion.idPublicacion
INNER JOIN compra
    ON compra.idPublicacionFinalizada = publicacionFinalizada.idPublicacion
WHERE compra.idUsuario = :idUsuario
UNION 
SELECT publicacion.*
FROM publicacion
INNER JOIN publicacionFinalizada
    ON publicacionFinalizada.idPublicacion = publicacion.idPublicacion
WHERE publicacion.idUsuario = :idUsuario;
\end{verbatim}

$\bullet$ Consulta por categoría de producto: obtener, dada una categoría de producto (``Computación'',
``Hogar, muebles y jardín'', etc), un listado de los vendedores que han publicado artículos de dicha
categoría y la cantidad de ventas que efectuó cada uno de dichos vendedores.

\begin{verbatim}
SELECT u.idUsuario, count(*)
FROM usuario u
INNER JOIN publicacion pu1 ON u.idUsuario = pu1.idUsuario
INNER JOIN compra co1 ON co1.idPublicacionFinalizada = pu1.idPublicacion
WHERE u.idUsuario IN (
    SELECT DISTINCT pu2.idUsuario
    FROM producto pr
    INNER JOIN item i ON pr.idItem == i.idItem
    INNER JOIN publicacion pu2 ON i.idPublicacion = pu2.idPublicacion
    INNER JOIN compra co2 ON co2.idPublicacionFinalizada = pu2.idPublicacion
    WHERE nombreCategoriaProducto = :categoria
)
GROUP BY u.idUsuario;
\end{verbatim}

$\bullet$ Función ``Ofertar'': debe permitir al usuario ofertar una suma en una subasta. Dicha suma debe
ser superior en al menos 1 peso, a la oferta actual, e inferior al doble de la oferta actual.

\begin{verbatim}
INSERT INTO hizoOferta VALUES (:idUsuario, :idPublicacion, datetime('now'), :monto)    
\end{verbatim}

$\bullet$ Consulta por usuario y preguntas: obtener para un usuario específico, la lista de preguntas que
ha realizado, con las respectivas respuestas que haya recibido (sólo la pregunta, si aún no recibió
respuesta).

\begin{verbatim}
SELECT p.pregunta, p.respuesta 
FROM pregunta p
WHERE p.idUsuario = :idUsuario;
\end{verbatim}

$\bullet$ Consulta por keyword: obtener, para un cierto keyword (por ejemplo ``mesa''), la lista de publicaciones
vigentes que tengan en el título, dicha keyword. El usuario debe poder restringir su
búsqueda sólo a cierta categoría de artículos o servicios.
 
\begin{verbatim}
SELECT p.idPublicacion
FROM publicacion p
WHERE p.tipoVigencia = 0
AND titulo LIKE :patron
AND (
    EXISTS (
        SELECT * 
        FROM item i
        INNER JOIN producto pr ON i.idItem = pr.idItem
        WHERE i.idPublicacion = p.idPublicacion
        AND pr.nombreCategoriaProducto = :categoria
    ) OR EXISTS
    (
        SELECT * 
        FROM item i
        INNER JOIN servicio s ON i.idItem = s.idItem
        WHERE i.idPublicacion = p.idPublicacion
        AND s.nombreTipoServicio = :categoria
    )
);
\end{verbatim}

$\bullet$ Consulta por ganador/es anual de viaje a Khan El-Khalili: obtener, para un año específico, el ganador/es

\begin{verbatim}
SELECT IFNULL(razonSocial, nombre || apellido) ganador,
        AVG(valoracionVendedor) * SUM(precio) puntaje,
        AVG(valoracionVendedor) calificacion_promedio,
        SUM(precio) suma_montos_abonados
FROM calificacion
INNER JOIN compra ON compra.idCalificacion = calificacion.idCalificacion
INNER JOIN publicacion ON publicacion.idPublicacion = compra.idPublicacionFinalizada
INNER JOIN usuario ON usuario.idUsuario = publicacion.idUsuario
LEFT JOIN particular ON particular.idUsuario = usuario.idUsuario
LEFT JOIN empresa ON empresa.idUsuario = usuario.idUsuario
GROUP BY usuario.idUsuario
ORDER BY AVG(valoracionVendedor) * SUM(precio) DESC
LIMIT 1;
\end{verbatim}
